name: Release

on:
  workflow_run:
    workflows: [ "CI" ]
    types: [ completed ]
    branches: [ main, master ]

permissions:
  contents: write
  packages: write
  issues: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      ! contains(github.event.workflow_run.head_commit.message, '[skip release]')

    steps:
      - name: Generate GitHub App token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
        continue-on-error: true

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Analyze commits
        id: analyze
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s")
          fi
          
          # Detect release type
          if echo "$COMMITS" | grep -qE "BREAKING[ -]CHANGE|^[a-z]+(\([^)]+\))?!: "; then
            RELEASE_TYPE="major"
            EMOJI="ðŸ’¥"
            DESC="Breaking changes detected"
          elif echo "$COMMITS" | grep -q "^feat"; then
            RELEASE_TYPE="minor"
            EMOJI="âœ¨"
            DESC="New features added"
          elif echo "$COMMITS" | grep -qE "^(fix|perf|deps)"; then
            RELEASE_TYPE="patch"
            EMOJI="ðŸ›"
            DESC="Bug fixes and improvements"
          else
            RELEASE_TYPE=""
            EMOJI="ðŸ“"
            DESC="No releasable changes"
          fi
          
          if [ -n "$RELEASE_TYPE" ]; then
            echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          # âœ¨ CHANGE: Enhanced summary with visual indicators
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“Š Release Analysis
          
          | Metric | Value |
          |--------|-------|
          | $EMOJI **Status** | $DESC |
          | ðŸ·ï¸ **Current Version** | \`$LATEST_TAG\` |
          | ðŸ“¦ **Release Type** | ${RELEASE_TYPE:-none} |
          | ðŸ“ **Commits Since Last Release** | $(echo "$COMMITS" | wc -l) |
          EOF

      - name: Generate release
        if: steps.analyze.outputs.should_release == 'true'
        id: release
        run: |
          set -e
          
          npx standard-version --release-as ${{ steps.analyze.outputs.release_type }}
          
          NEW_VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          git push --follow-tags origin ${{ github.event.workflow_run.head_branch }}

      - name: Extract release notes
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          awk '/^## \[/{if (++count == 2) exit} count == 1' CHANGELOG.md > RELEASE_NOTES.md

      - name: Create GitHub release
        if: steps.analyze.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.release.outputs.new_version }}
          name: Release v${{ steps.release.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          generate_release_notes: true
          make_latest: true

      - name: Notify Go module proxy
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          sleep 10
          
          VERSION="v${{ steps.release.outputs.new_version }}"
          MODULE="github.com/${{ github.repository }}"
          
          echo "ðŸ”„ Warming up Go module proxy..."
          curl -f "https://proxy.golang.org/${MODULE}/@v/${VERSION}.info" || true
          curl -f "https://sum.golang.org/lookup/${MODULE}@${VERSION}" || true
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“¦ Go Module Published
          
          \`\`\`bash
          go get ${MODULE}@${VERSION}
          \`\`\`
          
          [ðŸ“– View on pkg.go.dev](https://pkg.go.dev/${MODULE}@${VERSION})
          EOF

      - name: Generate final summary
        if: always()
        run: |
          if [ "${{ steps.analyze.outputs.should_release }}" == "true" ]; then
            VERSION="v${{ steps.release.outputs.new_version }}"
            cat >> $GITHUB_STEP_SUMMARY << EOF
          
          ---
          
          ## ðŸŽ‰ Release $VERSION Published! 
          
          **Installation:**
          \`\`\`bash
          go get github.com/${{ github.repository }}@$VERSION
          \`\`\`
          
          **Links:**
          - ðŸ“‹ [Release Notes](https://github.com/${{ github.repository }}/releases/tag/$VERSION)
          - ðŸ“¦ [pkg.go.dev](https://pkg.go.dev/github.com/${{ github.repository }}@$VERSION)
          - ðŸ“ [CHANGELOG. md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          EOF
          else
            echo "## â„¹ï¸ No Release Required" >> $GITHUB_STEP_SUMMARY
            echo "No releasable changes detected in this push." >> $GITHUB_STEP_SUMMARY
          fi