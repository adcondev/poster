name: Release

on:
  workflow_run:
    workflows: [ "CI" ]
    types: [ completed ]
    branches: [ main, master ]

permissions:
  contents: write
  packages: write
  issues: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release:
    name: ðŸš€ Create Release
    runs-on: ubuntu-latest
    # FIX 1: Prevent infinite loops by ignoring release commits
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      !contains(github.event.workflow_run.head_commit.message, 'chore(release)') &&
      !contains(github.event.workflow_run.head_commit.message, '[skip ci]') &&
      !contains(github.event.workflow_run.head_commit.message, '[skip release]')

    steps:
      - name: Generate GitHub App token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
        continue-on-error: true

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Analyze commits
        id: analyze
        run: |
          # 1. Obtener el Ãºltimo tag de Git
          git fetch --tags
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Ãšltimo Tag detectado: $LATEST_TAG"
          
          # --- NUEVO: AUTO-CURACIÃ“N ---
          # Sincronizamos package.json con el Tag de Git antes de empezar.
          # Esto previene el error "null" si el archivo estaba corrupto.
          CLEAN_VERSION=${LATEST_TAG#v} # Quita la 'v' del tag
          if [ "$CLEAN_VERSION" != "0.0.0" ]; then
             echo "ðŸ”§ Sincronizando package.json a versiÃ³n $CLEAN_VERSION para asegurar estabilidad..."
             npm version $CLEAN_VERSION --no-git-tag-version --allow-same-version || true
          fi
          # ----------------------------
          
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s")
          fi
          
          # AnÃ¡lisis de Conventional Commits
          if echo "$COMMITS" | grep -qE "BREAKING[ -]CHANGE|^[a-z]+(\([^)]+\))?!:"; then
            RELEASE_TYPE="major"
            EMOJI="ðŸ’¥"
            DESC="Breaking changes detected"
          elif echo "$COMMITS" | grep -q "^feat"; then
            RELEASE_TYPE="minor"
            EMOJI="âœ¨"
            DESC="New features added"
          elif echo "$COMMITS" | grep -qE "^(fix|perf|deps)"; then
            RELEASE_TYPE="patch"
            EMOJI="ðŸ›"
            DESC="Bug fixes and improvements"
          else
            RELEASE_TYPE=""
            EMOJI="ðŸ“"
            DESC="No releasable changes"
          fi
          
          if [ -n "$RELEASE_TYPE" ]; then
            echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ“Š Release Analysis
          | Metric | Value |
          |--------|-------|
          | $EMOJI **Status** | $DESC |
          | ðŸ·ï¸ **Current Version** | \`$LATEST_TAG\` |
          | ðŸ“¦ **Next Release** | ${RELEASE_TYPE:-none} |
          EOF

      - name: Generate release
        if: steps.analyze.outputs.should_release == 'true'
        id: release
        run: |
          set -e
          echo "ðŸ”„ Running standard-version..."
          
          # FIX 3: Run release tool with error handling
          if ! npx standard-version --release-as ${{ steps.analyze.outputs.release_type }}; then
            echo "âŒ standard-version failed"
            exit 1
          fi
          
          NEW_VERSION=$(git describe --tags --abbrev=0 2>/dev/null | sed 's/^v//')
          
          # FIX 4: CRITICAL validation to prevent vnull tags
          if [ -z "$NEW_VERSION" ]; then
            echo "âŒ Failed to extract version from git tag"
            exit 1
          fi
          
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          if ! git push --follow-tags origin ${{ github.event.workflow_run.head_branch }}; then
            echo "âŒ Failed to push tags"
            git tag -d "v${NEW_VERSION}" 2>/dev/null || true
            exit 1
          fi

      - name: Extract release notes
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          awk '/^## \[/{if (++count == 2) exit} count == 1' CHANGELOG.md > RELEASE_NOTES.md
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "## Release v${{ steps.release.outputs.new_version }}" > RELEASE_NOTES.md
            echo "See CHANGELOG.md for details." >> RELEASE_NOTES.md
          fi

      - name: Create GitHub release
        if: steps.analyze.outputs.should_release == 'true' && steps.release.outputs.new_version != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.release.outputs.new_version }}
          name: Release v${{ steps.release.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          generate_release_notes: true
          make_latest: true

      - name: Notify Go module proxy
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          sleep 10
          VERSION="v${{ steps.release.outputs.new_version }}"
          MODULE="github.com/${{ github.repository }}"
          curl -sf "https://proxy.golang.org/${MODULE}/@v/${VERSION}.info" || true