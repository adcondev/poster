name: Release Notes

on:
  workflow_run:
    workflows: [ "CI" ]
    types:
      - completed
    branches: [ main, master ]

permissions:
  contents: write
  packages: write
  issues: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    concurrency:
      group: release-${{ github.ref }}
      cancel-in-progress: false
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      !contains(github.event.workflow_run.head_commit.message, 'chore(release)') &&
      !contains(github.event.workflow_run.head_commit.message, '[skip ci]') &&
      !contains(github.event.workflow_run.head_commit.message, '[skip release]')

    steps:
      - name: Generate token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
        continue-on-error: true

      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Analyze commits
        id: analyze
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

          # More robust breaking change detection
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            COMMITS=$(git log --pretty=format:"%s" HEAD)
          else
            COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s")
          fi

          # Enhanced detection for breaking changes
          if echo "$COMMITS" | grep -qE "BREAKING[ -]CHANGE|^[a-z]+(\([^)]+\))?!:"; then
            RELEASE_TYPE="major"
            echo "ðŸ”¥ Breaking change detected!"
          elif echo "$COMMITS" | grep -q "^feat"; then
            RELEASE_TYPE="minor"
            echo "âœ¨ New features detected!"
          elif echo "$COMMITS" | grep -qE "^(fix|perf|deps)"; then
            RELEASE_TYPE="patch"
            echo "ðŸ› Fixes detected!"
          else
            RELEASE_TYPE=""
            echo "ðŸ“ No releasable changes"
          fi

          if [ -n "$RELEASE_TYPE" ]; then
            echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          else
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

          # Generate summary
          echo "## ðŸ“Š Release Analysis" >> $GITHUB_STEP_SUMMARY
          echo "- Current version: $LATEST_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- Release type: ${RELEASE_TYPE:-none}" >> $GITHUB_STEP_SUMMARY
          echo "- Next version: $([ -n "$RELEASE_TYPE" ] && echo "Will calculate..." || echo "No release")" >> $GITHUB_STEP_SUMMARY

      - name: Generate Release Notes
        if: steps.analyze.outputs.should_release == 'true'
        id: release
        run: |
          set -e  # Exit on error
          
          # Run standard-version
          if ! npx standard-version --release-as ${{ steps.analyze.outputs.release_type }}; then
            echo "âŒ standard-version failed"
            exit 1
          fi
          
          # Get the new version from the git tag
          NEW_VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
          # Push changes with error handling
          if ! git push --follow-tags origin ${{ github.event.workflow_run.head_branch }}; then
            echo "âŒ Failed to push tags"
            git tag -d "v${NEW_VERSION}"  # Cleanup local tag
            exit 1
          fi

      - name: Extract Release Notes
        if: steps.analyze.outputs.should_release == 'true'
        id: extract_notes
        run: |
          # Extract only the latest version's changelog
          awk '/^## \[/{if (++count == 2) exit} count == 1' CHANGELOG.md > RELEASE_NOTES.md

      - name: Create GitHub Release
        if: steps.analyze.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.release.outputs.new_version }}
          name: Release v${{ steps.release.outputs.new_version }}
          body_path: RELEASE_NOTES.md
          generate_release_notes: true
          make_latest: true

      - name: Warm up Go Proxy
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          # Give GitHub a moment to process the tag
          sleep 10

          # Trigger proxy.golang.org to fetch the new version
          curl -f "https://proxy.golang.org/github.com/${{ github.repository }}/@v/v${{ steps.release.outputs.new_version }}.info" || true

          echo "âœ… Go module proxy notified" >> $GITHUB_STEP_SUMMARY

      - name: Generate Go Module Release Info
        if: steps.analyze.outputs.should_release == 'true'
        run: |
          echo "ðŸ“¦ Go Module Release Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "```bash" >> $GITHUB_STEP_SUMMARY
          echo "go get github.com/${{ github.repository }}@v${{ steps.release.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "```" >> $GITHUB_STEP_SUMMARY

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.analyze.outputs.should_release }}" == "true" ]; then
            echo "## ðŸš€ Release v${{ steps.release.outputs.new_version }} Published!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Install:** \`go get github.com/${{ github.repository }}@v${{ steps.release.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/v${{ steps.release.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ No Release Created" >> $GITHUB_STEP_SUMMARY
            echo "No releasable changes detected." >> $GITHUB_STEP_SUMMARY
          fi