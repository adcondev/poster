name: Dependabot Auto-merge

on:
  pull_request_target:
    types: [ opened, synchronize, reopened ]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  checks: read

concurrency:
  group: dependabot-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  auto-merge:
    name: ğŸ¤– Auto-merge Dependencies
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Ensure required labels exist
        run: |
          create_label() {
            local name=$1 color=$2 description=$3
            gh api repos/${{ github.repository }}/labels \
              -X POST \
              -f name="$name" \
              -f color="$color" \
              -f description="$description" 2>/dev/null || true
          }
          
          create_label "dependencies" "0366d6" "Dependency updates"
          create_label "needs-review" "ededed" "Requires manual review"
          create_label "auto-merge" "22863a" "Auto-merge enabled"
          create_label "major-update" "b60205" "Major version update"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Evaluate update type
        id: evaluate
        run: |
          UPDATE_TYPE="${{ steps.metadata.outputs.update-type }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          DEPENDENCY="${{ steps.metadata.outputs.dependency-names }}"
          
          gh pr edit $PR_NUMBER --add-label "dependencies"
          
          if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
            echo "is_major=true" >> $GITHUB_OUTPUT
            gh pr edit $PR_NUMBER --add-label "major-update,needs-review"
          
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âš ï¸ Major Update Detected
          
          **Dependency:** \`$DEPENDENCY\`
          **Update Type:** Major version
          **Action:** Manual review required
          EOF
          else
            echo "is_major=false" >> $GITHUB_OUTPUT
            gh pr edit $PR_NUMBER --add-label "auto-merge"
          
            cat >> $GITHUB_STEP_SUMMARY << EOF
          ## âœ… Auto-merge Eligible
          
          **Dependency:** \`$DEPENDENCY\`
          **Update Type:** ${UPDATE_TYPE}
          **Action:** Will auto-merge after checks pass
          EOF
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Wait for CI checks
        if: steps.evaluate.outputs.is_major == 'false'
        uses: lewagon/wait-on-check-action@v1.4.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-regexp: '.*'
          wait-interval: 10
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          allowed-conclusions: success
          running-workflow-name: 'auto-merge'

      - name: Approve and merge
        if: steps.evaluate.outputs.is_major == 'false'
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          gh pr review $PR_NUMBER --approve --body "âœ… Auto-approved by Dependabot workflow"
          gh pr merge $PR_NUMBER --auto --squash --delete-branch
          
          echo "âœ… PR #$PR_NUMBER approved and queued for merge" >> $GITHUB_STEP_SUMMARY
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        if: steps.evaluate.outputs.is_major == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const metadata = {
              updateType: "${{ steps.metadata.outputs.update-type }}",
              dependencyNames: "${{ steps.metadata.outputs.dependency-names }}",
              previousVersion: "${{ steps.metadata.outputs.previous-version }}",
              newVersion: "${{ steps.metadata.outputs.new-version }}",
              ecosystem: "${{ steps.metadata.outputs.package-ecosystem }}"
            };
            
            const comment = `## ğŸ’¥ Major Version Update
            
            This PR contains a **major version update** that requires manual review before merging.
            
            ### ğŸ“¦ Update Details
            
            | Item | Value |
            |------|-------|
            | **Dependency** | \`${metadata.dependencyNames}\` |
            | **Ecosystem** | ${metadata.ecosystem} |
            | **Current Version** | \`${metadata.previousVersion}\` |
            | **New Version** | \`${metadata.newVersion}\` |
            | **Update Type** | \`${metadata.updateType}\` |
            
            ### âœ… Review Checklist
            
            - [ ] Review [release notes and changelog](https://github.com/search?q=repo: ${metadata.dependencyNames}+${metadata.newVersion}&type=releases)
            - [ ] Check for [breaking changes](https://github.com/${metadata.dependencyNames}/releases)
            - [ ] Review [security advisories](https://github.com/${metadata.dependencyNames}/security/advisories)
            - [ ] Test locally if needed
            - [ ] Update code for breaking changes
            
            ### ğŸ”— Useful Links
            
            - [ğŸ“‹ Release Notes](https://github.com/${metadata.dependencyNames}/releases)
            - [ğŸ”’ Security](https://github.com/${metadata.dependencyNames}/security)
            - [ğŸ“š Documentation](https://github.com/${metadata.dependencyNames})
            
            ---
            
            â„¹ï¸ Once reviewed, manually approve and merge this PR.`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });